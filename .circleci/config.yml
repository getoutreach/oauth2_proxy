defaults: &defaults
  # http://code.openark.org/blog/development/forking-golang-repositories-on-github-and-managing-the-import-path
  working_directory: /go/src/github.com/bitly/oauth2_proxy
  docker:
    - image: golang:1.10

version: 2
jobs:
  build:
    <<: *defaults
    steps:
      - checkout
      - run:
          name: Test
          command: |
            curl -s https://raw.githubusercontent.com/pote/gpm/v1.4.0/bin/gpm > gpm
            chmod +x gpm
            ./gpm install
            ./test.sh
      - run:
          name: Build
          command: make build
      - run:
          name: Docker Build
          command: make docker
      - deploy:
          name: Deploy package to s3
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
              apt-get update
              apt-get install -y ruby-full python-pip
              gem install fpm
              pip install awscli
              cd /go/src/github.com/bitly/oauth2_proxy
              make package
              make release
            fi
