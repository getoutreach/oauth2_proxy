defaults: &defaults
  # http://code.openark.org/blog/development/forking-golang-repositories-on-github-and-managing-the-import-path
  working_directory: /go/src/github.com/bitly/oauth2_proxy
  docker:
    - image: golang:1.10

version: 2
jobs:
  build:
    <<: *defaults
    steps:
      - checkout
      - run:
          name: Install Docker client
          command: |
            set -x
            VER="17.09.0-ce"
            curl -L https://download.docker.com/linux/static/stable/x86_64/docker-$VER.tgz | \
            tar -xzf - > /usr/bin/docker
            chmod +x /usr/bin/docker
      - run:
          name: Install GPM and Dependencies
          command: |
            curl -L https://raw.githubusercontent.com/pote/gpm/v1.4.0/bin/gpm > /usr/bin/gpm
            chmod +x /usr/bin/gpm
            gpm install
      - run:
          name: Run Tests
          command: ./test.sh
      - run:
          name: Build Binary
          command: |
            make build
      - run:
          name: Build Docker Image
          command: |
            docker build -t oauth2_proxy:latest .
      - deploy:
          name: Upload package to s3
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
              apt-get update
              apt-get install -y ruby-full python-pip
              gem install fpm
              pip install awscli
              make release
            fi
      - deploy:
          name: Docker Push
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
              docker login -u $REGISTRY_USER -p $REGISTRY_PASSWD registry.outreach.cloud

              repo='registry.outreach.cloud/oauth2_proxy'
              tag=$(awk -F'"' '/^const VERSION/ {printf "%s", $$2}' version.go)

              docker tag oauth2_proxy:latest ${repo}:${tag}
              docker push ${repo}:${tag}
              docker tag oauth2_proxy:latest ${repo}:latest
            fi
